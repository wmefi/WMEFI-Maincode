{% extends 'wtestapp/base.html' %}
{% load static %}

{% block title %}Agreement{% endblock %}

{% block style %}
<style>
  :root{ --teal:#64c5cb; --purple:#c0769e; --pink:#e664a2; --bg:#fdeef4; --card:#ffffff; }
  body{ background: var(--bg); }
  .card-agreement{ background:var(--card); border:1px solid var(--pink); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:40px 50px; max-width: 1200px; margin: 0 auto; }
  /* Horizontal progress steps */
  .progress-steps{ display:flex; align-items:center; justify-content:center; gap:25px; flex-wrap:nowrap; margin-bottom:25px; }
  .step{ display:flex; align-items:center; gap:12px; }
  .step .dot{ width:42px; height:42px; border-radius:50%; background:#ddd; color:#555; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; }
  .step.active .dot{ background:var(--pink); color:#fff; }
  .step .label{ font-weight:600; color:#7b3f63; font-size:16px; }
  .agreement-text{ max-height:400px; overflow:auto; border:1px dashed var(--pink); border-radius:12px; padding:30px 40px; background:#fff; font-size: 14px; line-height: 1.7; }
  /* Make included agreement content align/fit nicely without changing text */
  .agreement-text * { box-sizing: border-box; }
  .agreement-text h1, .agreement-text h3, .agreement-text h4 { margin-top: 0; }
  .agreement-text img { max-width: 100%; height: auto; }
  .agreement-text .pdf-header { width: 100% !important; }
  .agreement-text table { width: 100% !important; border-collapse: collapse; }
  .agreement-text p { margin-bottom: 8px; }
  .agreement-text img, .agreement-text table { margin: 0 auto; }
  /* Signature pad and buttons */
  .sig-pad{ border:2px dashed var(--purple); border-radius:12px; width:100%; height:200px; background:#fff; cursor:crosshair; }
  .sig-actions .btn{ margin-right:10px; }
  .btn-primary{ background:var(--pink); border-color:var(--pink); }
  .btn-primary:hover{ background:var(--purple); border-color:var(--purple); }
  .btn-outline-secondary{ color:var(--purple); border-color:var(--purple); }
  /* Ensure consistent agreement fonts on page (override PDF styles for web view) */
  .card-agreement, .card-agreement * { font-family: Arial, Helvetica, sans-serif; }
  .agreement-text h1 { font-size: 18px !important; margin-bottom: 18px !important; }
  .agreement-text h3 { font-size: 15px !important; margin: 15px 0 !important; }
  .agreement-text h4 { font-size: 14px !important; margin: 12px 0 !important; }
  .agreement-text p { font-size: 13px !important; margin: 8px 0 !important; line-height: 1.6 !important; }
  .agreement-text ol li { font-size: 13px !important; margin: 8px 0 !important; line-height: 1.6 !important; }
  .agreement-text .signature-table { margin-top: 35px !important; width: 100% !important; border-collapse: collapse !important; }
  .agreement-text .signature-table td { width: 45% !important; vertical-align: top !important; text-align: left !important; padding: 0 !important; }
  .agreement-text .signature-table td:first-child { padding-right: 30px !important; }
  .agreement-text .signature-table td:last-child { padding-left: 30px !important; text-align: right !important; }
  .agreement-text .signature-block p { font-size: 13px !important; margin: 6px 0 !important; line-height: 1.5 !important; }
  .agreement-text .signature-block strong { font-size: 14px !important; font-weight: 700 !important; }
  .agreement-text .signature-block { text-align: left !important; }
  .agreement-text .logo-header { text-align: center !important; margin-bottom: 15px !important; }
  .agreement-text .logo-header img { max-width: 100px !important; height: auto !important; margin: 0 auto !important; }
  .agreement-text .company-sig-image { max-width: 140px !important; max-height: 55px !important; }
  .agreement-text .signature-image { max-width: 140px !important; max-height: 55px !important; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="progress-steps">
    <div class="step"><div class="dot">1</div><div class="label">Login</div></div>
    <div class="step"><div class="dot">2</div><div class="label">Profile</div></div>
    <div class="step active"><div class="dot">3</div><div class="label">Agreement</div></div>
    <div class="step"><div class="dot">4</div><div class="label">Survey</div></div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="card-agreement">
    <h2 class="mb-3" style="color:var(--purple); font-weight:700; text-align: center; font-size: 22px;">Participant Agreement</h2>
    <h4 class="mb-2" style="color:#7b3f63; font-weight: 600; font-size: 17px;">Dr. {{ doctor.first_name }} {{ doctor.last_name }}</h4>
    <p class="mb-3" style="color:#666; font-size: 14px;">Mobile: <strong>{{ doctor.mobile|default:'Not provided' }}</strong></p>

    <form method="post" action="{% url 'agreement_page' survey_id=survey.id %}" onsubmit="return submitAgreement(event)">
      {% csrf_token %}

      <div class="form-group mb-4">
        <label class="font-weight-bold" style="font-size: 15px; color: #7b3f63; margin-bottom: 12px; display: block;">Agreement Text</label>
        <div class="agreement-text">
          {% include 'wtestapp/agreement_web_template.html' with doctor=doctor amount=amount survey_title=survey_title signed_date=signed_date %}
        </div>
      </div>

      <div class="form-group mb-4">
        <label class="font-weight-bold" style="font-size: 15px; color: #7b3f63; margin-bottom: 10px; display: block;">Digital Signature</label>
        <div class="mb-2" style="font-size: 13px; color: #666;">Draw your signature below or type your name.</div>
        <canvas id="signatureCanvas" class="sig-pad"></canvas>
        <div class="sig-actions mt-3">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSignature()" style="font-size: 13px; padding: 6px 14px;">Clear</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="typeSignature()" style="font-size: 13px; padding: 6px 14px;">Type Signature</button>
        </div>
        <input type="hidden" name="signature_data" id="signature_data">
        <input type="hidden" name="signature_type" id="signature_type" value="drawn">
        <input type="hidden" name="client_signed_date" id="client_signed_date">
      </div>

      <div class="form-check mb-4" style="padding-left: 28px;">
        <input class="form-check-input" type="checkbox" id="agree" name="agree" required style="width: 18px; height: 18px; margin-top: 2px;">
        <label class="form-check-label" for="agree" style="font-size: 14px; line-height: 1.6; color: #555; margin-left: 8px;">
          I, <strong>Dr. {{ doctor.first_name }} {{ doctor.last_name }}</strong>, hereby confirm that I have read and understood the terms and conditions of the Participant Agreement for the survey titled <strong>{{ survey.title|default:'Survey' }}</strong> and I voluntarily agree to participate in this study.
        </label>
      </div>

      <div class="text-right">
        <button type="submit" class="btn btn-primary btn-lg" style="font-size: 16px; padding: 10px 28px;">Accept & Continue</button>
      </div>
    </form>
  </div>
</div>

<script>
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let typedFallback = '';

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#222';
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Pretty date formatter used for preview and submission
  function formatClientDate(){
    const d = new Date();
    const day = d.getDate();
    const suffix = (n)=>{ const j=n%10, k=n%100; if (j==1 && k!=11) return 'st'; if (j==2 && k!=12) return 'nd'; if (j==3 && k!=13) return 'rd'; return 'th'; };
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    return `${day}${suffix(day)} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  // Update the on-page included agreement preview to show client local date
  function setPreviewSignedDate(){
    const container = document.querySelector('.agreement-text');
    if(!container) return;
    const formatted = formatClientDate();
    const ps = container.querySelectorAll('p');
    ps.forEach(p=>{
      const t = (p.textContent||'').trim();
      if(t.startsWith('Date :')){
        p.textContent = 'Date : ' + formatted;
      }
    });
    // also replace intro date spans
    container.querySelectorAll('.signed-date').forEach(el=>{ el.textContent = formatted; });
  }

  document.addEventListener('DOMContentLoaded', setPreviewSignedDate);

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches.length){ e = e.touches[0]; }
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
  canvas.addEventListener('mousedown', e=>{ drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  canvas.addEventListener('mouseup', ()=> drawing=false);
  canvas.addEventListener('mouseleave', ()=> drawing=false);
  canvas.addEventListener('touchstart', e=>{ drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('touchmove', e=>{ if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); });
  canvas.addEventListener('touchend', ()=> drawing=false);

  function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); document.getElementById('signature_type').value = 'drawn'; typedFallback = ''; }

  function typeSignature(){
    const name = prompt('Type your full name for signature:','{{ doctor.first_name }} {{ doctor.last_name }}');
    if(name){
      typedFallback = name;
      document.getElementById('signature_type').value = 'typed';
      // render typed signature onto canvas for preview
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.font = '28px cursive';
      ctx.fillStyle = '#222';
      ctx.fillText(name, 20, 120);
    }
  }

  function submitAgreement(e){
    const agree = document.getElementById('agree');
    if(!agree.checked){ alert('Please accept the agreement to continue.'); return false; }

    const type = document.getElementById('signature_type').value;
    const hidden = document.getElementById('signature_data');

    if(type === 'typed'){
      if(!typedFallback){ alert('Please type your signature.'); return false; }
      hidden.value = 'typed:' + typedFallback;
    } else {
      // detect if canvas is empty by reading pixels
      const blank = document.createElement('canvas');
      blank.width = canvas.width; blank.height = canvas.height;
      if(canvas.toDataURL() === blank.toDataURL()){
        alert('Please draw your signature.');
        return false;
      }
      hidden.value = canvas.toDataURL('image/png');
    }
    // capture client's local date in pretty format
    try {
      const d = new Date();
      const day = d.getDate();
      const suffix = (n)=>{ const j=n%10, k=n%100; if (j==1 && k!=11) return 'st'; if (j==2 && k!=12) return 'nd'; if (j==3 && k!=13) return 'rd'; return 'th'; };
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const formatted = `${day}${suffix(day)} ${months[d.getMonth()]} ${d.getFullYear()}`;
      document.getElementById('client_signed_date').value = formatted;
    } catch(err) { /* ignore */ }
    return true;
  }
</script>
{% endblock %}
