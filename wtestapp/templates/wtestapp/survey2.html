{% extends 'wtestapp/base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Current Management of Moderate & Severe Anaemia (Zone - 1){% endblock %}

{% block style %}
<style>
  :root{ --teal:#64c5cb; --purple:#c0769e; --pink:#e664a2; --bg:#fdeef4; --card:#ffffff; }
  body{ background: var(--bg); }
  .survey-card{ background:var(--card); border:1px solid var(--pink); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.1); padding:24px; }
  .q-title{ font-weight:700; color:var(--purple); font-size: 1.1rem; margin-bottom: 10px; }
  .form-section{ padding:12px 16px; border-radius:12px; background: #fff; margin-bottom:16px; }
  .form-section.answered{ border: 1px solid #28a745; box-shadow: 0 6px 14px rgba(40,167,69,.08); background: #f1fff6; }
  .form-section.invalid{ border: 1px solid #dc3545; box-shadow: 0 6px 14px rgba(220,53,69,.08); }
  .btn-primary{ background:var(--pink); border-color:var(--pink); padding: 12px 22px; border-radius: 10px; font-weight:700; }
  .btn-primary:hover{ background:var(--purple); border-color:var(--purple); }
  .btn-ghost{ border:1px solid var(--purple); color:var(--purple); border-radius:10px; padding:10px 16px; font-weight:600; background:#fff; }
  .btn-ghost:hover{ background:var(--purple); color:#fff; }
  .option-list{ list-style:none; padding-left:0; margin: 0; }
  .option-item{ display:flex; align-items:center; margin: 8px 0; }
  .option-item input{ position: absolute; opacity: 0; }
  .square-indicator{ width:18px; height:18px; border:2px solid var(--pink); border-radius:4px; display:inline-block; margin-right:10px; transition: all .15s ease; background:#fff; }
  .option-item input[type="radio"]:checked + .square-indicator,
  .option-item input[type="checkbox"]:checked + .square-indicator{ background: #28a745; border-color: #28a745; box-shadow: 0 0 0 2px rgba(40,167,69,.15); }
  /* Make the label text green when selected */
  .option-item input[type="radio"]:checked + .square-indicator + .option-label,
  .option-item input[type="checkbox"]:checked + .square-indicator + .option-label{ color:#28a745; font-weight:700; }
  .option-label{ margin:0; color:#7b3f63; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="survey-card">
    <h3 class="mb-2" style="font-size: 1.4rem; font-weight: 800;">Current Management of Moderate & Severe Anaemia (Zone - 1)</h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post">
      {% csrf_token %}

      {% for q in questions %}
        <div class="form-section" data-qname="{{ q.name }}" data-qtype="{{ q.type }}">
          <div class="q-title">{{ forloop.counter }}. {{ q.title }}</div>

          {% if q.type == 'radio' %}
            <ul class="option-list">
              {% for opt in q.options %}
              <li class="option-item">
                <input type="radio" id="{{ q.name }}_{{ forloop.counter }}" name="{{ q.name }}" value="{{ opt }}" {% if answers|dict_get:q.name == opt %}checked{% endif %}>
                <span class="square-indicator"></span>
                <label class="option-label" for="{{ q.name }}_{{ forloop.counter }}">{{ opt }}</label>
              </li>
              {% endfor %}
            </ul>
          {% elif q.type == 'checkbox' %}
            <ul class="option-list">
              {% for opt in q.options %}
              <li class="option-item">
                {% with ans_list=answers|dict_get:q.name %}
                <input type="checkbox" id="{{ q.name }}_{{ forloop.counter }}" name="{{ q.name }}" value="{{ opt }}" {% if opt|in_list:ans_list %}checked{% endif %}>
                {% endwith %}
                <span class="square-indicator"></span>
                <label class="option-label" for="{{ q.name }}_{{ forloop.counter }}">{{ opt }}</label>
              </li>
              {% endfor %}
            </ul>
          {% endif %}
          <div class="invalid-feedback d-block" style="display:none; color:#dc3545; font-weight:600; margin-top:6px;">
            Please answer this question.
          </div>
        </div>
      {% endfor %}

      <div class="d-flex justify-content-between">
        <button type="submit" name="submit_action" value="save" class="btn btn-ghost">Save Draft</button>
        <div>
          <button type="submit" name="submit_action" value="reset" class="btn btn-ghost mr-2">Clear Selections</button>
          <button type="submit" name="submit_action" value="submit" class="btn btn-primary">Submit Survey</button>
        </div>
      </div>
    </form>
    <script>
      (function(){
        var form = document.querySelector('form');
        if(!form) return;
        // Helper to update answered state styling per section immediately on selection
        function updateSectionAnswered(sec){
          var qname = sec.getAttribute('data-qname');
          var qtype = sec.getAttribute('data-qtype');
          var answered = false;
          if(qtype === 'radio'){
            answered = !!form.querySelector('input[name="'+qname+'"]:checked');
          } else if(qtype === 'checkbox'){
            var checked = form.querySelectorAll('input[name="'+qname+'"]:checked');
            answered = checked && checked.length > 0;
          }
          if(answered){
            sec.classList.add('answered');
            var err = sec.querySelector('.invalid-feedback');
            if(err){ err.style.display = 'none'; }
            sec.style.border = '';
          } else {
            sec.classList.remove('answered');
          }
        }

        // Attach change listeners to all inputs to toggle green styling instantly
        var sectionsInit = form.querySelectorAll('.form-section');
        sectionsInit.forEach(function(sec){
          var inputs = sec.querySelectorAll('input[type="radio"], input[type="checkbox"]');
          inputs.forEach(function(inp){
            inp.addEventListener('change', function(){ updateSectionAnswered(sec); });
          });
          // Initialize on load in case of pre-filled values
          updateSectionAnswered(sec);
        });

        form.addEventListener('submit', function(e){
          var ok = true;
          var sections = form.querySelectorAll('.form-section');
          sections.forEach(function(sec){
            var qname = sec.getAttribute('data-qname');
            var qtype = sec.getAttribute('data-qtype');
            var err = sec.querySelector('.invalid-feedback');
            if(err){ err.style.display = 'none'; }
            sec.style.borderColor = '';
            var answered = false;
            if(qtype === 'radio'){
              answered = !!form.querySelector('input[name="'+qname+'"]:checked');
            } else if(qtype === 'checkbox') {
              var checked = form.querySelectorAll('input[name="'+qname+'"]:checked');
              answered = checked && checked.length > 0;
            }
            if(!answered){
              ok = false;
              if(err){ err.style.display = 'block'; }
              sec.style.border = '1px solid #dc3545';
              sec.scrollIntoView({behavior:'smooth', block:'center'});
            }
            // keep answered class in sync on submit validation
            if(answered){ sec.classList.add('answered'); } else { sec.classList.remove('answered'); }
          });
          if(!ok){
            e.preventDefault();
          }
        });
      })();
    </script>
  </div>
</div>
{% endblock %}
